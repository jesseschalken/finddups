'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.report = report;

var _reading = require('./reading');

var _util = require('./util');

var _readline = require('readline');

var readline = _interopRequireWildcard(_readline);

var _promise_fs = require('./promise_fs');

var fs = _interopRequireWildcard(_promise_fs);

var _path = require('path');

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

async function report(roots) {
  let groups = gatherDuplicates(roots);

  await runReport(groups);
}

function amountDuplicated(nodes) {
  if (nodes.length === 0) return 0;
  return deepSize(nodes[0]) * (nodes.length - 1);
}

function deepSize(node) {
  let size = 0;
  for (let node2 of (0, _reading.traverse)(node)) {
    size += node2.size;
  }
  return size;
}

function getDuplicateCids(roots) {
  let one = new Set();
  let many = new Set();
  for (let root of roots) {
    for (let node of (0, _reading.traverse)(root)) {
      let { cid } = node;
      if (one.has(cid)) {
        many.add(cid);
      } else {
        one.add(cid);
      }
    }
  }
  return many;
}

function gatherDuplicates(roots) {
  let dups = getDuplicateCids(roots);
  let map = new Map();
  function add(node) {
    let { cid } = node;
    if (!dups.has(cid)) {
      for (let child of node.children) {
        add(child);
      }
    } else {
      let list = map.get(cid);
      if (list === undefined) {
        list = [];
        map.set(cid, list);
      }
      list.push(node);
    }
  }
  for (let root of roots) {
    add(root);
  }
  return Array.from(map.values()).filter(x => x.length > 1);
}

async function runReport(groups) {
  groups = groups.sort((a, b) => amountDuplicated(b) - amountDuplicated(a));

  let rl = new Readline();
  let index = 0;
  let quit = false;
  while (groups.length > 0 && !quit) {
    index = (index + groups.length) % groups.length;
    let group = groups[index];
    let count = group.length;
    let bytes = (0, _util.formatBytes)(amountDuplicated(group));
    let info = group[0].type.name + ' ' + group[0].cid;

    await (0, _util.printLn)();
    await (0, _util.printLn)(`${index + 1}/${groups.length}: ${info} (${count} copies, ${bytes} duplicated)`);

    let options = new Map();
    for (let i = 0; i < group.length; i++) {
      let { path } = group[i];
      options.set(`${i + 1}`, {
        name: `Keep only "${path.get()}"`,
        async action() {
          for (let j = 0; j < group.length; j++) {
            let { path: path2 } = group[j];
            if (i !== j) {
              await removeRecursive(path2.get());
            }
          }
          // Delete the group
          groups.splice(index, 1);
        }
      });
    }
    options.set('D', {
      name: 'Delete ALL',
      async action() {
        for (let { path } of group) {
          await removeRecursive(path.get());
        }
        // Delete the group
        groups.splice(index, 1);
      }
    });
    options.set('n', {
      name: 'Next duplicate',
      async action() {
        index++;
      }
    });
    options.set('p', {
      name: 'Previous duplicate',
      async action() {
        index--;
      }
    });
    options.set('q', {
      name: 'Quit',
      async action() {
        quit = true;
      }
    });
    await rl.choose(options);
  }
  rl.close();
  await (0, _util.printLn)();
  if (quit) {
    await (0, _util.printLn)('Quit');
  } else {
    await (0, _util.printLn)('DONE');
  }
}

class Readline {
  constructor() {
    this.rl = readline.createInterface({
      input: process.stdin,
      output: process.stdout
    });
  }
  close() {
    this.rl.close();
  }
  async choose(options) {
    while (true) {
      let question = 'Please select an option:\n';
      for (let [key, { name }] of options) {
        question += `  ${key}: ${name}\n`;
      }
      question += '> ';
      let response = await new Promise(resolve => {
        this.rl.question(question, answer => {
          resolve(answer);
        });
      });
      response = response.trim();
      let option = options.get(response);
      if (option !== undefined) {
        await option.action();
        return;
      }
    }
  }
}

async function removeRecursive(path) {
  let stat = await fs.lstat(path);
  if (stat.isDirectory()) {
    for (let name of await fs.readdir(path)) {
      await removeRecursive(path + _path.sep + name);
    }
    await (0, _util.printLn)('rmdir ' + path);
    await fs.rmdir(path);
  } else {
    await (0, _util.printLn)('unlink ' + path);
    await fs.unlink(path);
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZXBvcnRpbmcuanMiXSwibmFtZXMiOlsicmVwb3J0IiwicmVhZGxpbmUiLCJmcyIsInJvb3RzIiwiZ3JvdXBzIiwiZ2F0aGVyRHVwbGljYXRlcyIsInJ1blJlcG9ydCIsImFtb3VudER1cGxpY2F0ZWQiLCJub2RlcyIsImxlbmd0aCIsImRlZXBTaXplIiwibm9kZSIsInNpemUiLCJub2RlMiIsImdldER1cGxpY2F0ZUNpZHMiLCJvbmUiLCJTZXQiLCJtYW55Iiwicm9vdCIsImNpZCIsImhhcyIsImFkZCIsImR1cHMiLCJtYXAiLCJNYXAiLCJjaGlsZCIsImNoaWxkcmVuIiwibGlzdCIsImdldCIsInVuZGVmaW5lZCIsInNldCIsInB1c2giLCJBcnJheSIsImZyb20iLCJ2YWx1ZXMiLCJmaWx0ZXIiLCJ4Iiwic29ydCIsImEiLCJiIiwicmwiLCJSZWFkbGluZSIsImluZGV4IiwicXVpdCIsImdyb3VwIiwiY291bnQiLCJieXRlcyIsImluZm8iLCJ0eXBlIiwibmFtZSIsIm9wdGlvbnMiLCJpIiwicGF0aCIsImFjdGlvbiIsImoiLCJwYXRoMiIsInJlbW92ZVJlY3Vyc2l2ZSIsInNwbGljZSIsImNob29zZSIsImNsb3NlIiwiY29uc3RydWN0b3IiLCJjcmVhdGVJbnRlcmZhY2UiLCJpbnB1dCIsInByb2Nlc3MiLCJzdGRpbiIsIm91dHB1dCIsInN0ZG91dCIsInF1ZXN0aW9uIiwia2V5IiwicmVzcG9uc2UiLCJQcm9taXNlIiwicmVzb2x2ZSIsImFuc3dlciIsInRyaW0iLCJvcHRpb24iLCJzdGF0IiwibHN0YXQiLCJpc0RpcmVjdG9yeSIsInJlYWRkaXIiLCJybWRpciIsInVubGluayJdLCJtYXBwaW5ncyI6Ijs7Ozs7UUFTc0JBLE0sR0FBQUEsTTs7QUFOdEI7O0FBQ0E7O0FBQ0E7O0lBQVlDLFE7O0FBQ1o7O0lBQVlDLEU7O0FBQ1o7Ozs7QUFFTyxlQUFlRixNQUFmLENBQXNCRyxLQUF0QixFQUE0RDtBQUNqRSxNQUFJQyxTQUFTQyxpQkFB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QUQsRUFBTixDQUFULElBQTBCQyxPQUExQixFQUFtQztBQUNqQ2lCLG9CQUFhLEtBQUlDLEdBQUksS0FBSW5CLElBQUssSUFBOUI7QUFDRDtBQUNEa0Isa0JBQVksSUFBWjtBQUNBLFVBQUlFLFdBQVcsTUFBTSxJQUFJQyxPQUFKLENBQVlDLFdBQVc7QUFDMUMsYUFBSy9CLEVBQUwsQ0FBUTJCLFFBQVIsQ0FBaUJBLFFBQWpCLEVBQTJCSyxVQUFVO0FBQ25DRCxrQkFBUUMsTUFBUjtBQUNELFNBRkQ7QUFHRCxPQUpvQixDQUFyQjtBQUtBSCxpQkFBV0EsU0FBU0ksSUFBVCxFQUFYO0FBQ0EsVUFBSUMsU0FBU3hCLFFBQVF0QixHQUFSLENBQVl5QyxRQUFaLENBQWI7QUFDQSxVQUFJSyxXQUFXN0MsU0FBZixFQUEwQjtBQUN4QixjQUFNNkMsT0FBT3JCLE1BQVAsRUFBTjtBQUNBO0FBQ0Q7QUFDRjtBQUNGO0FBOUJZOztBQWlDZixlQUFlRyxlQUFmLENBQStCSixJQUEvQixFQUE0RDtBQUMxRCxNQUFJdUIsT0FBTyxNQUFNekUsR0FBRzBFLEtBQUgsQ0FBU3hCLElBQVQsQ0FBakI7QUFDQSxNQUFJdUIsS0FBS0UsV0FBTCxFQUFKLEVBQXdCO0FBQ3RCLFNBQUssSUFBSTVCLElBQVQsSUFBaUIsTUFBTS9DLEdBQUc0RSxPQUFILENBQVcxQixJQUFYLENBQXZCLEVBQXlDO0FBQ3ZDLFlBQU1JLGdCQUFnQkosbUJBQWlCSCxJQUFqQyxDQUFOO0FBQ0Q7QUFDRCxVQUFNLG1CQUFRLFdBQVdHLElBQW5CLENBQU47QUFDQSxVQUFNbEQsR0FBRzZFLEtBQUgsQ0FBUzNCLElBQVQsQ0FBTjtBQUNELEdBTkQsTUFNTztBQUNMLFVBQU0sbUJBQVEsWUFBWUEsSUFBcEIsQ0FBTjtBQUNBLFVBQU1sRCxHQUFHOEUsTUFBSCxDQUFVNUIsSUFBVixDQUFOO0FBQ0Q7QUFDRiIsImZpbGUiOiJyZXBvcnRpbmcuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuXG5pbXBvcnQgdHlwZSB7Q29tcGxldGVOb2RlfSBmcm9tICcuL3JlYWRpbmcnO1xuaW1wb3J0IHt0cmF2ZXJzZX0gZnJvbSAnLi9yZWFkaW5nJztcbmltcG9ydCB7Zm9ybWF0Qnl0ZXMsIHByaW50TG59IGZyb20gJy4vdXRpbCc7XG5pbXBvcnQgKiBhcyByZWFkbGluZSBmcm9tICdyZWFkbGluZSc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICcuL3Byb21pc2VfZnMnO1xuaW1wb3J0IHtzZXAgYXMgRElSX1NFUH0gZnJvbSAncGF0aCc7XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZXBvcnQocm9vdHM6IENvbXBsZXRlTm9kZVtdKTogUHJvbWlzZTx2b2lkPiB7XG4gIGxldCBncm91cHMgPSBnYXRoZXJEdXBsaWNhdGVzKHJvb3RzKTtcblxuICBhd2FpdCBydW5SZXBvcnQoZ3JvdXBzKTtcbn1cblxuZnVuY3Rpb24gYW1vdW50RHVwbGljYXRlZChub2RlczogQ29tcGxldGVOb2RlW10pOiBudW1iZXIge1xuICBpZiAobm9kZXMubGVuZ3RoID09PSAwKSByZXR1cm4gMDtcbiAgcmV0dXJuIGRlZXBTaXplKG5vZGVzWzBdKSAqIChub2Rlcy5sZW5ndGggLSAxKTtcbn1cblxuZnVuY3Rpb24gZGVlcFNpemUobm9kZTogQ29tcGxldGVOb2RlKTogbnVtYmVyIHtcbiAgbGV0IHNpemUgPSAwO1xuICBmb3IgKGxldCBub2RlMiBvZiB0cmF2ZXJzZShub2RlKSkge1xuICAgIHNpemUgKz0gbm9kZTIuc2l6ZTtcbiAgfVxuICByZXR1cm4gc2l6ZTtcbn1cblxuZnVuY3Rpb24gZ2V0RHVwbGljYXRlQ2lkcyhyb290czogQ29tcGxldGVOb2RlW10pOiBTZXQ8bnVtYmVyPiB7XG4gIGxldCBvbmUgPSBuZXcgU2V0KCk7XG4gIGxldCBtYW55ID0gbmV3IFNldCgpO1xuICBmb3IgKGxldCByb290IG9mIHJvb3RzKSB7XG4gICAgZm9yIChsZXQgbm9kZSBvZiB0cmF2ZXJzZShyb290KSkge1xuICAgICAgbGV0IHtjaWR9ID0gbm9kZTtcbiAgICAgIGlmIChvbmUuaGFzKGNpZCkpIHtcbiAgICAgICAgbWFueS5hZGQoY2lkKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG9uZS5hZGQoY2lkKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgcmV0dXJuIG1hbnk7XG59XG5cbmZ1bmN0aW9uIGdhdGhlckR1cGxpY2F0ZXMocm9vdHM6IENvbXBsZXRlTm9kZVtdKTogQ29tcGxldGVOb2RlW11bXSB7XG4gIGxldCBkdXBzID0gZ2V0RHVwbGljYXRlQ2lkcyhyb290cyk7XG4gIGxldCBtYXAgPSBuZXcgTWFwKCk7XG4gIGZ1bmN0aW9uIGFkZChub2RlOiBDb21wbGV0ZU5vZGUpOiB2b2lkIHtcbiAgICBsZXQge2NpZH0gPSBub2RlO1xuICAgIGlmICghZHVwcy5oYXMoY2lkKSkge1xuICAgICAgZm9yIChsZXQgY2hpbGQgb2Ygbm9kZS5jaGlsZHJlbikge1xuICAgICAgICBhZGQoY2hpbGQpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBsZXQgbGlzdCA9IG1hcC5nZXQoY2lkKTtcbiAgICAgIGlmIChsaXN0ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgbGlzdCA9IFtdO1xuICAgICAgICBtYXAuc2V0KGNpZCwgbGlzdCk7XG4gICAgICB9XG4gICAgICBsaXN0LnB1c2gobm9kZSk7XG4gICAgfVxuICB9XG4gIGZvciAobGV0IHJvb3Qgb2Ygcm9vdHMpIHtcbiAgICBhZGQocm9vdCk7XG4gIH1cbiAgcmV0dXJuIEFycmF5LmZyb20obWFwLnZhbHVlcygpKS5maWx0ZXIoeCA9PiB4Lmxlbmd0aCA+IDEpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBydW5SZXBvcnQoZ3JvdXBzOiBDb21wbGV0ZU5vZGVbXVtdKTogUHJvbWlzZTx2b2lkPiB7XG4gIGdyb3VwcyA9IGdyb3Vwcy5zb3J0KChhLCBiKSA9PiBhbW91bnREdXBsaWNhdGVkKGIpIC0gYW1vdW50RHVwbGljYXRlZChhKSk7XG5cbiAgbGV0IHJsID0gbmV3IFJlYWRsaW5lKCk7XG4gIGxldCBpbmRleCA9IDA7XG4gIGxldCBxdWl0ID0gZmFsc2U7XG4gIHdoaWxlIChncm91cHMubGVuZ3RoID4gMCAmJiAhcXVpdCkge1xuICAgIGluZGV4ID0gKGluZGV4ICsgZ3JvdXBzLmxlbmd0aCkgJSBncm91cHMubGVuZ3RoO1xuICAgIGxldCBncm91cCA9IGdyb3Vwc1tpbmRleF07XG4gICAgbGV0IGNvdW50ID0gZ3JvdXAubGVuZ3RoO1xuICAgIGxldCBieXRlcyA9IGZvcm1hdEJ5dGVzKGFtb3VudER1cGxpY2F0ZWQoZ3JvdXApKTtcbiAgICBsZXQgaW5mbyA9IGdyb3VwWzBdLnR5cGUubmFtZSArICcgJyArIGdyb3VwWzBdLmNpZDtcblxuICAgIGF3YWl0IHByaW50TG4oKTtcbiAgICBhd2FpdCBwcmludExuKFxuICAgICAgYCR7aW5kZXggK1xuICAgICAgICAxfS8ke2dyb3Vwcy5sZW5ndGh9OiAke2luZm99ICgke2NvdW50fSBjb3BpZXMsICR7Ynl0ZXN9IGR1cGxpY2F0ZWQpYCxcbiAgICApO1xuXG4gICAgbGV0IG9wdGlvbnMgPSBuZXcgTWFwKCk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBncm91cC5sZW5ndGg7IGkrKykge1xuICAgICAgbGV0IHtwYXRofSA9IGdyb3VwW2ldO1xuICAgICAgb3B0aW9ucy5zZXQoYCR7aSArIDF9YCwge1xuICAgICAgICBuYW1lOiBgS2VlcCBvbmx5IFwiJHtwYXRoLmdldCgpfVwiYCxcbiAgICAgICAgYXN5bmMgYWN0aW9uKCkge1xuICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgZ3JvdXAubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgIGxldCB7cGF0aDogcGF0aDJ9ID0gZ3JvdXBbal07XG4gICAgICAgICAgICBpZiAoaSAhPT0gaikge1xuICAgICAgICAgICAgICBhd2FpdCByZW1vdmVSZWN1cnNpdmUocGF0aDIuZ2V0KCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICAvLyBEZWxldGUgdGhlIGdyb3VwXG4gICAgICAgICAgZ3JvdXBzLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9XG4gICAgb3B0aW9ucy5zZXQoJ0QnLCB7XG4gICAgICBuYW1lOiAnRGVsZXRlIEFMTCcsXG4gICAgICBhc3luYyBhY3Rpb24oKSB7XG4gICAgICAgIGZvciAobGV0IHtwYXRofSBvZiBncm91cCkge1xuICAgICAgICAgIGF3YWl0IHJlbW92ZVJlY3Vyc2l2ZShwYXRoLmdldCgpKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBEZWxldGUgdGhlIGdyb3VwXG4gICAgICAgIGdyb3Vwcy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgfSxcbiAgICB9KTtcbiAgICBvcHRpb25zLnNldCgnbicsIHtcbiAgICAgIG5hbWU6ICdOZXh0IGR1cGxpY2F0ZScsXG4gICAgICBhc3luYyBhY3Rpb24oKSB7XG4gICAgICAgIGluZGV4Kys7XG4gICAgICB9LFxuICAgIH0pO1xuICAgIG9wdGlvbnMuc2V0KCdwJywge1xuICAgICAgbmFtZTogJ1ByZXZpb3VzIGR1cGxpY2F0ZScsXG4gICAgICBhc3luYyBhY3Rpb24oKSB7XG4gICAgICAgIGluZGV4LS07XG4gICAgICB9LFxuICAgIH0pO1xuICAgIG9wdGlvbnMuc2V0KCdxJywge1xuICAgICAgbmFtZTogJ1F1aXQnLFxuICAgICAgYXN5bmMgYWN0aW9uKCkge1xuICAgICAgICBxdWl0ID0gdHJ1ZTtcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgYXdhaXQgcmwuY2hvb3NlKG9wdGlvbnMpO1xuICB9XG4gIHJsLmNsb3NlKCk7XG4gIGF3YWl0IHByaW50TG4oKTtcbiAgaWYgKHF1aXQpIHtcbiAgICBhd2FpdCBwcmludExuKCdRdWl0Jyk7XG4gIH0gZWxzZSB7XG4gICAgYXdhaXQgcHJpbnRMbignRE9ORScpO1xuICB9XG59XG5cbmludGVyZmFjZSBSZWFkbGluZUFjdGlvbiB7XG4gICtuYW1lOiBzdHJpbmc7XG4gICthY3Rpb246ICgpID0+IFByb21pc2U8dm9pZD47XG59XG5cbmNsYXNzIFJlYWRsaW5lIHtcbiAgcmw6IHJlYWRsaW5lLkludGVyZmFjZTtcbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5ybCA9IHJlYWRsaW5lLmNyZWF0ZUludGVyZmFjZSh7XG4gICAgICBpbnB1dDogcHJvY2Vzcy5zdGRpbixcbiAgICAgIG91dHB1dDogcHJvY2Vzcy5zdGRvdXQsXG4gICAgfSk7XG4gIH1cbiAgY2xvc2UoKTogdm9pZCB7XG4gICAgdGhpcy5ybC5jbG9zZSgpO1xuICB9XG4gIGFzeW5jIGNob29zZShvcHRpb25zOiBNYXA8c3RyaW5nLCBSZWFkbGluZUFjdGlvbj4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgbGV0IHF1ZXN0aW9uID0gJ1BsZWFzZSBzZWxlY3QgYW4gb3B0aW9uOlxcbic7XG4gICAgICBmb3IgKGxldCBba2V5LCB7bmFtZX1dIG9mIG9wdGlvbnMpIHtcbiAgICAgICAgcXVlc3Rpb24gKz0gYCAgJHtrZXl9OiAke25hbWV9XFxuYDtcbiAgICAgIH1cbiAgICAgIHF1ZXN0aW9uICs9ICc+ICc7XG4gICAgICBsZXQgcmVzcG9uc2UgPSBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgICAgdGhpcy5ybC5xdWVzdGlvbihxdWVzdGlvbiwgYW5zd2VyID0+IHtcbiAgICAgICAgICByZXNvbHZlKGFuc3dlcik7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgICByZXNwb25zZSA9IHJlc3BvbnNlLnRyaW0oKTtcbiAgICAgIGxldCBvcHRpb24gPSBvcHRpb25zLmdldChyZXNwb25zZSk7XG4gICAgICBpZiAob3B0aW9uICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgYXdhaXQgb3B0aW9uLmFjdGlvbigpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJlbW92ZVJlY3Vyc2l2ZShwYXRoOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgbGV0IHN0YXQgPSBhd2FpdCBmcy5sc3RhdChwYXRoKTtcbiAgaWYgKHN0YXQuaXNEaXJlY3RvcnkoKSkge1xuICAgIGZvciAobGV0IG5hbWUgb2YgYXdhaXQgZnMucmVhZGRpcihwYXRoKSkge1xuICAgICAgYXdhaXQgcmVtb3ZlUmVjdXJzaXZlKHBhdGggKyBESVJfU0VQICsgbmFtZSk7XG4gICAgfVxuICAgIGF3YWl0IHByaW50TG4oJ3JtZGlyICcgKyBwYXRoKTtcbiAgICBhd2FpdCBmcy5ybWRpcihwYXRoKTtcbiAgfSBlbHNlIHtcbiAgICBhd2FpdCBwcmludExuKCd1bmxpbmsgJyArIHBhdGgpO1xuICAgIGF3YWl0IGZzLnVubGluayhwYXRoKTtcbiAgfVxufVxuIl19