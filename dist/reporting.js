'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.report = report;

var _reading = require('./reading');

var _util = require('./util');

var _readline = require('readline');

var readline = _interopRequireWildcard(_readline);

var _promise_fs = require('./promise_fs');

var fs = _interopRequireWildcard(_promise_fs);

var _path = require('path');

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

async function report(roots) {
  let groups = gatherDuplicates(roots);

  await runReport(groups);
}

function amountDuplicated(nodes) {
  if (nodes.length === 0) return 0;
  return deepSize(nodes[0]) * (nodes.length - 1);
}

function deepSize(node) {
  let size = 0;
  for (let node2 of (0, _reading.traverse)(node)) {
    size += node2.size;
  }
  return size;
}

function getDuplicateCids(roots) {
  let one = new Set();
  let many = new Set();
  for (let root of roots) {
    for (let node of (0, _reading.traverse)(root)) {
      let { cid } = node;
      if (one.has(cid)) {
        many.add(cid);
      } else {
        one.add(cid);
      }
    }
  }
  return many;
}

function gatherDuplicates(roots) {
  let dups = getDuplicateCids(roots);
  let map = new Map();
  function add(node) {
    let { cid } = node;
    if (!dups.has(cid)) {
      for (let child of node.children) {
        add(child);
      }
    } else {
      let list = map.get(cid);
      if (list === undefined) {
        list = [];
        map.set(cid, list);
      }
      list.push(node);
    }
  }
  for (let root of roots) {
    add(root);
  }
  return Array.from(map.values()).filter(x => x.length > 1);
}

async function runReport(groups) {
  groups = groups.sort((a, b) => amountDuplicated(b) - amountDuplicated(a));

  let rl = new Readline();
  let index = 0;
  let quit = false;
  while (groups.length > 0 && !quit) {
    index = (index + groups.length) % groups.length;
    let group = groups[index];
    let count = group.length;
    let bytes = (0, _util.formatBytes)(amountDuplicated(group));
    let info = group[0].type.name + ' ' + group[0].cid;

    await (0, _util.printLn)();
    await (0, _util.printLn)(`${index + 1}/${groups.length}: ${info} (${count} copies, ${bytes} duplicated)`);

    let options = new Map();
    for (let i = 0; i < group.length; i++) {
      let { path } = group[i];
      options.set(i + 1 + '', {
        name: `Keep only "${path.get()}"`,
        async action() {
          for (let j = 0; j < group.length; j++) {
            let { path: path2 } = group[j];
            if (i !== j) {
              await removeRecursive(path2.get());
            }
          }
          // Delete the group
          groups.splice(index, 1);
        }
      });
    }
    options.set('D', {
      name: 'Delete ALL',
      async action() {
        for (let { path } of group) {
          await removeRecursive(path.get());
        }
        // Delete the group
        groups.splice(index, 1);
      }
    });
    options.set('n', {
      name: 'Next duplicate',
      async action() {
        index++;
      }
    });
    options.set('p', {
      name: 'Previous duplicate',
      async action() {
        index--;
      }
    });
    options.set('q', {
      name: 'Quit',
      async action() {
        quit = true;
      }
    });
    await rl.choose(options);
  }
  rl.close();
  if (quit) {
    await (0, _util.printLn)('Quit');
  } else {
    await (0, _util.printLn)('DONE');
  }
}

class Readline {
  constructor() {
    this.rl = readline.createInterface({
      input: process.stdin,
      output: process.stdout
    });
  }
  close() {
    this.rl.close();
  }
  async choose(options) {
    while (true) {
      let question = 'Please select an option:\n';
      for (let [key, { name }] of options) {
        question += `  ${key}: ${name}\n`;
      }
      question += '> ';
      let response = await new Promise(resolve => {
        this.rl.question(question, answer => {
          resolve(answer);
        });
      });
      response = response.trim();
      let option = options.get(response);
      if (option !== undefined) {
        await option.action();
        return;
      }
    }
  }
}

async function removeRecursive(path) {
  let stat = await fs.lstat(path);
  if (stat.isDirectory()) {
    for (let name of await fs.readdir(path)) {
      await removeRecursive(path + _path.sep + name);
    }
    await (0, _util.printLn)('rmdir ' + path);
    await fs.rmdir(path);
  } else {
    await (0, _util.printLn)('unlink ' + path);
    await fs.unlink(path);
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZXBvcnRpbmcuanMiXSwibmFtZXMiOlsicmVwb3J0IiwicmVhZGxpbmUiLCJmcyIsInJvb3RzIiwiZ3JvdXBzIiwiZ2F0aGVyRHVwbGljYXRlcyIsInJ1blJlcG9ydCIsImFtb3VudER1cGxpY2F0ZWQiLCJub2RlcyIsImxlbmd0aCIsImRlZXBTaXplIiwibm9kZSIsInNpemUiLCJub2RlMiIsImdldER1cGxpY2F0ZUNpZHMiLCJvbmUiLCJTZXQiLCJtYW55Iiwicm9vdCIsImNpZCIsImhhcyIsImFkZCIsImR1cHMiLCJtYXAiLCJNYXAiLCJjaGlsZCIsImNoaWxkcmVuIiwibGlzdCIsImdldCIsInVuZGVmaW5lZCIsInNldCIsInB1c2giLCJBcnJheSIsImZyb20iLCJ2YWx1ZXMiLCJmaWx0ZXIiLCJ4Iiwic29ydCIsImEiLCJiIiwicmwiLCJSZWFkbGluZSIsImluZGV4IiwicXVpdCIsImdyb3VwIiwiY291bnQiLCJieXRlcyIsImluZm8iLCJ0eXBlIiwibmFtZSIsIm9wdGlvbnMiLCJpIiwicGF0aCIsImFjdGlvbiIsImoiLCJwYXRoMiIsInJlbW92ZVJlY3Vyc2l2ZSIsInNwbGljZSIsImNob29zZSIsImNsb3NlIiwiY29uc3RydWN0b3IiLCJjcmVhdGVJbnRlcmZhY2UiLCJpbnB1dCIsInByb2Nlc3MiLCJzdGRpbiIsIm91dHB1dCIsInN0ZG91dCIsInF1ZXN0aW9uIiwia2V5IiwicmVzcG9uc2UiLCJQcm9taXNlIiwicmVzb2x2ZSIsImFuc3dlciIsInRyaW0iLCJvcHRpb24iLCJzdGF0IiwibHN0YXQiLCJpc0RpcmVjdG9yeSIsInJlYWRkaXIiLCJybWRpciIsInVubGluayJdLCJtYXBwaW5ncyI6Ijs7Ozs7UUFTc0JBLE0sR0FBQUEsTTs7QUFOdEI7O0FBQ0E7O0FBQ0E7O0lBQVlDLFE7O0FBQ1o7O0lBQVlDLEU7O0FBQ1o7Ozs7QUFFTyxlQUFlRixNQUFmLENBQXNCRyxLQUF0QixFQUE0RDtBQUNqRSxNQUFJQyxTQUFTQyxpQkFBaUJGLEtBQWpCLENBQWI7O0FBRUEsUUFBTUcsVUFBVUYsTUFBVixDQUFOO0FBQ0Q7O0FBRUQsU0FBU0csZ0JBQVQsQ0FBMEJDLEtBQTFCLEVBQXlEO0FBQ3ZELE1BQUlBLE1BQU1DLE1BQU4sS0FBaUIsQ0FBckIsRUFBd0IsT0FBTyxDQUFQO0FBQ3hCLFNBQU9DLFNBQVNGLE1BQU0sQ0FBTixDQUFULEtBQXNCQSxNQUFNQyxNQUFOLEdBQWUsQ0FBckMsQ0FBUDtBQUNEOztBQUVELFNBQVNDLFFBQVQsQ0FBa0JDLElBQWxCLEVBQThDO0FBQzVDLE1BQUlDLE9BQU8sQ0FBWDtBQUNBLE9BQUssSUFBSUMsS0FBVCxJQUFrQix1QkFBU0YsSUFBVCxDQUFsQixFQUFrQztBQUNoQ0MsWUFBUUMsTUFBTUQsSUFBZDtBQUNEO0FBQ0QsU0FBT0EsSUFBUDtBQUNEOztBQUVELFNBQVNFLGdCQUFULENBQTBCWCxLQUExQixFQUE4RDtBQUM1RCxNQUFJWSxNQUFNLElBQUlDLEdBQUosRUFBVjtBQUNBLE1BQUlDLE9BQU8sSUFBSUQsR0FBSixFQUFYO0FBQ0EsT0FBSyxJQUFJRSxJQUFULElBQWlCZixLQUFqQixFQUF3QjtBQUN0QixTQUFLLElBQUlRLElBQVQsSUFBaUIsdUJBQVNPLElBQVQsQ0FBakIsRUFBaUM7QUFDL0IsVUFBSSxFQUFDQyxHQUFELEtBQVFSLElBQVo7QUFDQSxVQUFJSSxJQUFJSyxHQUFKLENBQVFELEdBQVIsQ0FBSixFQUFrQjtBQUNoQkYsYUFBS0ksR0FBTCxDQUFTRixHQUFUO0FBQ0QsT0FGRCxNQUVPO0FBQ0xKLFlBQUlNLEdBQUosQ0FBUUYsR0FBUjtBQUNEO0FBQ0Y7QUFDRjtBQUNELFNBQU9GLElBQVA7QUFDRDs7QUFFRCxTQUFTWixnQkFBVCxDQUEwQkYsS0FBMUIsRUFBbUU7QUFDakUsTUFBSW1CLE9BQU9SLGlCQUFpQlgsS0FBakIsQ0FBWDtBQUNBLE1BQUlvQixNQUFNLElBQUlDLEdBQUosRUFBVjtBQUNBLFdBQVNILEdBQVQsQ0FBYVYsSUFBYixFQUF1QztBQUNyQyxRQUFJLEVBQUNRLEdBQUQsS0FBUVIsSUFBWjtBQUNBLFFBQUksQ0FBQ1csS0FBS0YsR0FBTCxDQUFTRCxHQUFULENBQUwsRUFBb0I7QUFDbEIsV0FBSyxJQUFJTSxLQUFULElBQWtCZCxLQUFLZSxRQUF2QixFQUFpQztBQUMvQkwsWUFBSUksS0FBSjtBQUNEO0FBQ0YsS0FKRCxNQUlPO0FBQ0wsVUFBSUUsT0FBT0osSUFBSUssR0FBSixDQUFRVCxHQUFSLENBQVg7QUFDQSxVQUFJUSxTQUFTRSxTQUFiLEVBQXdCO0FBQ3RCRixlQUFPLEVBQVA7QUFDQUosWUFBSU8sR0FBSixDQUFRWCxHQUFSLEVBQWFRLElBQWI7QUFDRDtBQUNEQSxXQUFLSSxJQUFMLENBQVVwQixJQUFWO0FBQ0Q7QUFDRjtBQUNELE9BQUssSUFBSU8sSUFBVCxJQUFpQmYsS0FBakIsRUFBd0I7QUFDdEJrQixRQUFJSCxJQUFKO0FBQ0Q7QUFDRCxTQUFPYyxNQUFNQyxJQUFOLENBQVdWLElBQUlXLE1BQUosRUFBWCxFQUF5QkMsTUFBekIsQ0FBZ0NDLEtBQUtBLEVBQUUzQixNQUFGLEdBQVcsQ0FBaEQsQ0FBUDtBQUNEOztBQUVELGVBQWVILFNBQWYsQ0FBeUJGLE1BQXpCLEVBQWtFO0FBQ2hFQSxXQUFTQSxPQUFPaUMsSUFBUCxDQUFZLENBQUNDLENBQUQsRUFBSUMsQ0FBSixLQUFVaEMsaUJBQWlCZ0MsQ0FBakIsSUFBc0JoQyxpQkFBaUIrQixDQUFqQixDQUE1QyxDQUFUOztBQUVBLE1BQUlFLEtBQUssSUFBSUMsUUFBSixFQUFUO0FBQ0EsTUFBSUMsUUFBUSxDQUFaO0FBQ0EsTUFBSUMsT0FBTyxLQUFYO0FBQ0EsU0FBT3ZDLE9BQU9LLE1BQVAsR0FBZ0IsQ0FBaEIsSUFBcUIsQ0FBQ2tDLElBQTdCLEVBQW1DO0FBQ2pDRCxZQUFRLENBQUNBLFFBQVF0QyxPQUFPSyxNQUFoQixJQUEwQkwsT0FBT0ssTUFBekM7QUFDQSxRQUFJbUMsUUFBUXhDLE9BQU9zQyxLQUFQLENBQVo7QUFDQSxRQUFJRyxRQUFRRCxNQUFNbkMsTUFBbEI7QUFDQSxRQUFJcUMsUUFBUSx1QkFBWXZDLGlCQUFpQnFDLEtBQWpCLENBQVosQ0FBWjtBQUNBLFFBQUlHLE9BQU9ILE1BQU0sQ0FBTixFQUFTSSxJQUFULENBQWNDLElBQWQsR0FBcUIsR0FBckIsR0FBMkJMLE1BQU0sQ0FBTixFQUFTekIsR0FBL0M7O0FBRUEsVUFBTSxvQkFBTjtBQUNBLFVBQU0sbUJBQ0gsR0FBRXVCLFFBQ0QsQ0FBRSxJQUFHdEMsT0FBT0ssTUFBTyxLQUFJc0MsSUFBSyxLQUFJRixLQUFNLFlBQVdDLEtBQU0sY0FGckQsQ0FBTjs7QUFLQSxRQUFJSSxVQUFVLElBQUkxQixHQUFKLEVBQWQ7QUFDQSxTQUFLLElBQUkyQixJQUFJLENBQWIsRUFBZ0JBLElBQUlQLE1BQU1uQyxNQUExQixFQUFrQzBDLEdBQWxDLEVBQXVDO0FBQ3JDLFVBQUksRUFBQ0MsSUFBRCxLQUFTUixNQUFNTyxDQUFOLENBQWI7QUFDQUQsY0FBUXBCLEdBQVIsQ0FBYXFCLElBQUksQ0FBTCxHQUFVLEVBQXRCLEVBQTBCO0FBQ3hCRixjQUFPLGNBQWFHLEtBQUt4QixHQUFMLEVBQVcsR0FEUDtBQUV4QixjQUFNeUIsTUFBTixHQUFlO0FBQ2IsZUFBSyxJQUFJQyxJQUFJLENBQWIsRUFBZ0JBLElBQUlWLE1BQU1uQyxNQUExQixFQUFrQzZDLEdBQWxDLEVBQXVDO0FBQ3JDLGdCQUFJLEVBQUNGLE1BQU1HLEtBQVAsS0FBZ0JYLE1BQU1VLENBQU4sQ0FBcEI7QUFDQSxnQkFBSUgsTUFBTUcsQ0FBVixFQUFhO0FBQ1gsb0JBQU1FLGdCQUFnQkQsTUFBTTNCLEdBQU4sRUFBaEIsQ0FBTjtBQUNEO0FBQ0Y7QUFDRDtBQUNBeEIsaUJBQU9xRCxNQUFQLENBQWNmLEtBQWQsRUFBcUIsQ0FBckI7QUFDRDtBQVh1QixPQUExQjtBQWFEO0FBQ0RRLFlBQVFwQixHQUFSLENBQVksR0FBWixFQUFpQjtBQUNmbUIsWUFBTSxZQURTO0FBRWYsWUFBTUksTUFBTixHQUFlO0FBQ2IsYUFBSyxJQUFJLEVBQUNELElBQUQsRUFBVCxJQUFtQlIsS0FBbkIsRUFBMEI7QUFDeEIsZ0JBQU1ZLGdCQUFnQkosS0FBS3hCLEdBQUwsRUFBaEIsQ0FBTjtBQUNEO0FBQ0Q7QUFDQXhCLGVBQU9xRCxNQUFQLENBQWNmLEtBQWQsRUFBcUIsQ0FBckI7QUFDRDtBQVJjLEtBQWpCO0FBVUFRLFlBQVFwQixHQUFSLENBQVksR0FBWixFQUFpQjtBQUNmbUIsWUFBTSxnQkFEUztBQUVmLFlBQU1JLE1BQU4sR0FBZTtBQUNiWDtBQUNEO0FBSmMsS0FBakI7QUFNQVEsWUFBUXBCLEdBQVIsQ0FBWSxHQUFaLEVBQWlCO0FBQ2ZtQixZQUFNLG9CQURTO0FBRWYsWUFBTUksTUFBTixHQUFlO0FBQ2JYO0FBQ0Q7QUFKYyxLQUFqQjtBQU1BUSxZQUFRcEIsR0FBUixDQUFZLEdBQVosRUFBaUI7QUFDZm1CLFlBQU0sTUFEUztBQUVmLFlBQU1JLE1BQU4sR0FBZTtBQUNiVixlQUFPLElBQVA7QUFDRDtBQUpjLEtBQWpCO0FBTUEsVUFBTUgsR0FBR2tCLE1BQUgsQ0FBVVIsT0FBVixDQUFOO0FBQ0Q7QUFDRFYsS0FBR21CLEtBQUg7QUFDQSxNQUFJaEIsSUFBSixFQUFVO0FBQ1IsVUFBTSxtQkFBUSxNQUFSLENBQU47QUFDRCxHQUZELE1BRU87QUFDTCxVQUFNLG1CQUFRLE1BQVIsQ0FBTjtBQUNEO0FBQ0Y7O0FBT0QsTUFBTUYsUUFBTixDQUFlO0FBRWJtQixnQkFBYztBQUNaLFNBQUtwQixFQUFMLEdBQVV2QyxTQUFTNEQsZUFBVCxDQUF5QjtBQUNqQ0MsYUFBT0MsUUFBUUMsS0FEa0I7QUFFakNDLGNBQVFGLFFBQVFHO0FBRmlCLEtBQXpCLENBQVY7QUFJRDtBQUNEUCxVQUFjO0FBQ1osU0FBS25CLEVBQUwsQ0FBUW1CLEtBQVI7QUFDRDtBQUNELFFBQU1ELE1BQU4sQ0FBYVIsT0FBYixFQUFrRTtBQUNoRSxXQUFPLElBQVAsRUFBYTtBQUNYLFVBQUlpQixXQUFXLDRCQUFmO0FBQ0EsV0FBSyxJQUFJLENBQUNDLEdBQUQsRUFBTSxFQUFDbkIsSUFBRCxFQUFOLENBQVQsSUFBMEJDLE9BQTFCLEVBQW1DO0FBQ2pDaUIsb0JBQWEsS0FBSUMsR0FBSSxLQUFJbkIsSUFBSyxJQUE5QjtBQUNEO0FBQ0RrQixrQkFBWSxJQUFaO0FBQ0EsVUFBSUUsV0FBVyxNQUFNLElBQUlDLE9BQUosQ0FBWUMsV0FBVztBQUMxQyxhQUFLL0IsRUFBTCxDQUFRMkIsUUFBUixDQUFpQkEsUUFBakIsRUFBMkJLLFVBQVU7QUFDbkNELGtCQUFRQyxNQUFSO0FBQ0QsU0FGRDtBQUdELE9BSm9CLENBQXJCO0FBS0FILGlCQUFXQSxTQUFTSSxJQUFULEVBQVg7QUFDQSxVQUFJQyxTQUFTeEIsUUFBUXRCLEdBQVIsQ0FBWXlDLFFBQVosQ0FBYjtBQUNBLFVBQUlLLFdBQVc3QyxTQUFmLEVBQTBCO0FBQ3hCLGNBQU02QyxPQUFPckIsTUFBUCxFQUFOO0FBQ0E7QUFDRDtBQUNGO0FBQ0Y7QUE5Qlk7O0FBaUNmLGVBQWVHLGVBQWYsQ0FBK0JKLElBQS9CLEVBQTREO0FBQzFELE1BQUl1QixPQUFPLE1BQU16RSxHQUFHMEUsS0FBSCxDQUFTeEIsSUFBVCxDQUFqQjtBQUNBLE1BQUl1QixLQUFLRSxXQUFMLEVBQUosRUFBd0I7QUFDdEIsU0FBSyxJQUFJNUIsSUFBVCxJQUFpQixNQUFNL0MsR0FBRzRFLE9BQUgsQ0FBVzFCLElBQVgsQ0FBdkIsRUFBeUM7QUFDdkMsWUFBTUksZ0JBQWdCSixtQkFBaUJILElBQWpDLENBQU47QUFDRDtBQUNELFVBQU0sbUJBQVEsV0FBV0csSUFBbkIsQ0FBTjtBQUNBLFVBQU1sRCxHQUFHNkUsS0FBSCxDQUFTM0IsSUFBVCxDQUFOO0FBQ0QsR0FORCxNQU1PO0FBQ0wsVUFBTSxtQkFBUSxZQUFZQSxJQUFwQixDQUFOO0FBQ0EsVUFBTWxELEdBQUc4RSxNQUFILENBQVU1QixJQUFWLENBQU47QUFDRDtBQUNGIiwiZmlsZSI6InJlcG9ydGluZy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5cbmltcG9ydCB0eXBlIHtDb21wbGV0ZU5vZGV9IGZyb20gJy4vcmVhZGluZyc7XG5pbXBvcnQge3RyYXZlcnNlfSBmcm9tICcuL3JlYWRpbmcnO1xuaW1wb3J0IHtmb3JtYXRCeXRlcywgcHJpbnRMbn0gZnJvbSAnLi91dGlsJztcbmltcG9ydCAqIGFzIHJlYWRsaW5lIGZyb20gJ3JlYWRsaW5lJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJy4vcHJvbWlzZV9mcyc7XG5pbXBvcnQge3NlcCBhcyBESVJfU0VQfSBmcm9tICdwYXRoJztcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlcG9ydChyb290czogQ29tcGxldGVOb2RlW10pOiBQcm9taXNlPHZvaWQ+IHtcbiAgbGV0IGdyb3VwcyA9IGdhdGhlckR1cGxpY2F0ZXMocm9vdHMpO1xuXG4gIGF3YWl0IHJ1blJlcG9ydChncm91cHMpO1xufVxuXG5mdW5jdGlvbiBhbW91bnREdXBsaWNhdGVkKG5vZGVzOiBDb21wbGV0ZU5vZGVbXSk6IG51bWJlciB7XG4gIGlmIChub2Rlcy5sZW5ndGggPT09IDApIHJldHVybiAwO1xuICByZXR1cm4gZGVlcFNpemUobm9kZXNbMF0pICogKG5vZGVzLmxlbmd0aCAtIDEpO1xufVxuXG5mdW5jdGlvbiBkZWVwU2l6ZShub2RlOiBDb21wbGV0ZU5vZGUpOiBudW1iZXIge1xuICBsZXQgc2l6ZSA9IDA7XG4gIGZvciAobGV0IG5vZGUyIG9mIHRyYXZlcnNlKG5vZGUpKSB7XG4gICAgc2l6ZSArPSBub2RlMi5zaXplO1xuICB9XG4gIHJldHVybiBzaXplO1xufVxuXG5mdW5jdGlvbiBnZXREdXBsaWNhdGVDaWRzKHJvb3RzOiBDb21wbGV0ZU5vZGVbXSk6IFNldDxudW1iZXI+IHtcbiAgbGV0IG9uZSA9IG5ldyBTZXQoKTtcbiAgbGV0IG1hbnkgPSBuZXcgU2V0KCk7XG4gIGZvciAobGV0IHJvb3Qgb2Ygcm9vdHMpIHtcbiAgICBmb3IgKGxldCBub2RlIG9mIHRyYXZlcnNlKHJvb3QpKSB7XG4gICAgICBsZXQge2NpZH0gPSBub2RlO1xuICAgICAgaWYgKG9uZS5oYXMoY2lkKSkge1xuICAgICAgICBtYW55LmFkZChjaWQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb25lLmFkZChjaWQpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICByZXR1cm4gbWFueTtcbn1cblxuZnVuY3Rpb24gZ2F0aGVyRHVwbGljYXRlcyhyb290czogQ29tcGxldGVOb2RlW10pOiBDb21wbGV0ZU5vZGVbXVtdIHtcbiAgbGV0IGR1cHMgPSBnZXREdXBsaWNhdGVDaWRzKHJvb3RzKTtcbiAgbGV0IG1hcCA9IG5ldyBNYXAoKTtcbiAgZnVuY3Rpb24gYWRkKG5vZGU6IENvbXBsZXRlTm9kZSk6IHZvaWQge1xuICAgIGxldCB7Y2lkfSA9IG5vZGU7XG4gICAgaWYgKCFkdXBzLmhhcyhjaWQpKSB7XG4gICAgICBmb3IgKGxldCBjaGlsZCBvZiBub2RlLmNoaWxkcmVuKSB7XG4gICAgICAgIGFkZChjaGlsZCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBsaXN0ID0gbWFwLmdldChjaWQpO1xuICAgICAgaWYgKGxpc3QgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBsaXN0ID0gW107XG4gICAgICAgIG1hcC5zZXQoY2lkLCBsaXN0KTtcbiAgICAgIH1cbiAgICAgIGxpc3QucHVzaChub2RlKTtcbiAgICB9XG4gIH1cbiAgZm9yIChsZXQgcm9vdCBvZiByb290cykge1xuICAgIGFkZChyb290KTtcbiAgfVxuICByZXR1cm4gQXJyYXkuZnJvbShtYXAudmFsdWVzKCkpLmZpbHRlcih4ID0+IHgubGVuZ3RoID4gMSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJ1blJlcG9ydChncm91cHM6IENvbXBsZXRlTm9kZVtdW10pOiBQcm9taXNlPHZvaWQ+IHtcbiAgZ3JvdXBzID0gZ3JvdXBzLnNvcnQoKGEsIGIpID0+IGFtb3VudER1cGxpY2F0ZWQoYikgLSBhbW91bnREdXBsaWNhdGVkKGEpKTtcblxuICBsZXQgcmwgPSBuZXcgUmVhZGxpbmUoKTtcbiAgbGV0IGluZGV4ID0gMDtcbiAgbGV0IHF1aXQgPSBmYWxzZTtcbiAgd2hpbGUgKGdyb3Vwcy5sZW5ndGggPiAwICYmICFxdWl0KSB7XG4gICAgaW5kZXggPSAoaW5kZXggKyBncm91cHMubGVuZ3RoKSAlIGdyb3Vwcy5sZW5ndGg7XG4gICAgbGV0IGdyb3VwID0gZ3JvdXBzW2luZGV4XTtcbiAgICBsZXQgY291bnQgPSBncm91cC5sZW5ndGg7XG4gICAgbGV0IGJ5dGVzID0gZm9ybWF0Qnl0ZXMoYW1vdW50RHVwbGljYXRlZChncm91cCkpO1xuICAgIGxldCBpbmZvID0gZ3JvdXBbMF0udHlwZS5uYW1lICsgJyAnICsgZ3JvdXBbMF0uY2lkO1xuXG4gICAgYXdhaXQgcHJpbnRMbigpO1xuICAgIGF3YWl0IHByaW50TG4oXG4gICAgICBgJHtpbmRleCArXG4gICAgICAgIDF9LyR7Z3JvdXBzLmxlbmd0aH06ICR7aW5mb30gKCR7Y291bnR9IGNvcGllcywgJHtieXRlc30gZHVwbGljYXRlZClgLFxuICAgICk7XG5cbiAgICBsZXQgb3B0aW9ucyA9IG5ldyBNYXAoKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGdyb3VwLmxlbmd0aDsgaSsrKSB7XG4gICAgICBsZXQge3BhdGh9ID0gZ3JvdXBbaV07XG4gICAgICBvcHRpb25zLnNldCgoaSArIDEpICsgJycsIHtcbiAgICAgICAgbmFtZTogYEtlZXAgb25seSBcIiR7cGF0aC5nZXQoKX1cImAsXG4gICAgICAgIGFzeW5jIGFjdGlvbigpIHtcbiAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGdyb3VwLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICBsZXQge3BhdGg6IHBhdGgyfSA9IGdyb3VwW2pdO1xuICAgICAgICAgICAgaWYgKGkgIT09IGopIHtcbiAgICAgICAgICAgICAgYXdhaXQgcmVtb3ZlUmVjdXJzaXZlKHBhdGgyLmdldCgpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgLy8gRGVsZXRlIHRoZSBncm91cFxuICAgICAgICAgIGdyb3Vwcy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfVxuICAgIG9wdGlvbnMuc2V0KCdEJywge1xuICAgICAgbmFtZTogJ0RlbGV0ZSBBTEwnLFxuICAgICAgYXN5bmMgYWN0aW9uKCkge1xuICAgICAgICBmb3IgKGxldCB7cGF0aH0gb2YgZ3JvdXApIHtcbiAgICAgICAgICBhd2FpdCByZW1vdmVSZWN1cnNpdmUocGF0aC5nZXQoKSk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gRGVsZXRlIHRoZSBncm91cFxuICAgICAgICBncm91cHMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgb3B0aW9ucy5zZXQoJ24nLCB7XG4gICAgICBuYW1lOiAnTmV4dCBkdXBsaWNhdGUnLFxuICAgICAgYXN5bmMgYWN0aW9uKCkge1xuICAgICAgICBpbmRleCsrO1xuICAgICAgfSxcbiAgICB9KTtcbiAgICBvcHRpb25zLnNldCgncCcsIHtcbiAgICAgIG5hbWU6ICdQcmV2aW91cyBkdXBsaWNhdGUnLFxuICAgICAgYXN5bmMgYWN0aW9uKCkge1xuICAgICAgICBpbmRleC0tO1xuICAgICAgfSxcbiAgICB9KTtcbiAgICBvcHRpb25zLnNldCgncScsIHtcbiAgICAgIG5hbWU6ICdRdWl0JyxcbiAgICAgIGFzeW5jIGFjdGlvbigpIHtcbiAgICAgICAgcXVpdCA9IHRydWU7XG4gICAgICB9LFxuICAgIH0pO1xuICAgIGF3YWl0IHJsLmNob29zZShvcHRpb25zKTtcbiAgfVxuICBybC5jbG9zZSgpO1xuICBpZiAocXVpdCkge1xuICAgIGF3YWl0IHByaW50TG4oJ1F1aXQnKTtcbiAgfSBlbHNlIHtcbiAgICBhd2FpdCBwcmludExuKCdET05FJyk7XG4gIH1cbn1cblxuaW50ZXJmYWNlIFJlYWRsaW5lQWN0aW9uIHtcbiAgK25hbWU6IHN0cmluZztcbiAgK2FjdGlvbjogKCkgPT4gUHJvbWlzZTx2b2lkPjtcbn1cblxuY2xhc3MgUmVhZGxpbmUge1xuICBybDogcmVhZGxpbmUuSW50ZXJmYWNlO1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLnJsID0gcmVhZGxpbmUuY3JlYXRlSW50ZXJmYWNlKHtcbiAgICAgIGlucHV0OiBwcm9jZXNzLnN0ZGluLFxuICAgICAgb3V0cHV0OiBwcm9jZXNzLnN0ZG91dCxcbiAgICB9KTtcbiAgfVxuICBjbG9zZSgpOiB2b2lkIHtcbiAgICB0aGlzLnJsLmNsb3NlKCk7XG4gIH1cbiAgYXN5bmMgY2hvb3NlKG9wdGlvbnM6IE1hcDxzdHJpbmcsIFJlYWRsaW5lQWN0aW9uPik6IFByb21pc2U8dm9pZD4ge1xuICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICBsZXQgcXVlc3Rpb24gPSAnUGxlYXNlIHNlbGVjdCBhbiBvcHRpb246XFxuJztcbiAgICAgIGZvciAobGV0IFtrZXksIHtuYW1lfV0gb2Ygb3B0aW9ucykge1xuICAgICAgICBxdWVzdGlvbiArPSBgICAke2tleX06ICR7bmFtZX1cXG5gO1xuICAgICAgfVxuICAgICAgcXVlc3Rpb24gKz0gJz4gJztcbiAgICAgIGxldCByZXNwb25zZSA9IGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgICB0aGlzLnJsLnF1ZXN0aW9uKHF1ZXN0aW9uLCBhbnN3ZXIgPT4ge1xuICAgICAgICAgIHJlc29sdmUoYW5zd2VyKTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICAgIHJlc3BvbnNlID0gcmVzcG9uc2UudHJpbSgpO1xuICAgICAgbGV0IG9wdGlvbiA9IG9wdGlvbnMuZ2V0KHJlc3BvbnNlKTtcbiAgICAgIGlmIChvcHRpb24gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBhd2FpdCBvcHRpb24uYWN0aW9uKCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gcmVtb3ZlUmVjdXJzaXZlKHBhdGg6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICBsZXQgc3RhdCA9IGF3YWl0IGZzLmxzdGF0KHBhdGgpO1xuICBpZiAoc3RhdC5pc0RpcmVjdG9yeSgpKSB7XG4gICAgZm9yIChsZXQgbmFtZSBvZiBhd2FpdCBmcy5yZWFkZGlyKHBhdGgpKSB7XG4gICAgICBhd2FpdCByZW1vdmVSZWN1cnNpdmUocGF0aCArIERJUl9TRVAgKyBuYW1lKTtcbiAgICB9XG4gICAgYXdhaXQgcHJpbnRMbigncm1kaXIgJyArIHBhdGgpO1xuICAgIGF3YWl0IGZzLnJtZGlyKHBhdGgpO1xuICB9IGVsc2Uge1xuICAgIGF3YWl0IHByaW50TG4oJ3VubGluayAnICsgcGF0aCk7XG4gICAgYXdhaXQgZnMudW5saW5rKHBhdGgpO1xuICB9XG59XG4iXX0=