'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.replaceLn = replaceLn;
exports.printLn = printLn;
exports.formatBytes = formatBytes;
exports.formatNumber = formatNumber;
exports.padString = padString;
exports.waitIO = waitIO;
exports.delay = delay;
exports.trackProgress = trackProgress;
exports.newCid = newCid;
exports.shuffle = shuffle;
exports.waitAll = waitAll;
exports.partition = partition;
exports.sum = sum;


// noinspection JSUnusedGlobalSymbols
function replaceLn(text) {
  const CLEAR = '\r\x1B[2K\x1B[?7l';
  return print(CLEAR + text);
}

function printLn(text = '') {
  return print(text + '\n');
}

function print(text) {
  return new Promise((resolve, reject) => {
    process.stdout.write(text, err => {
      err ? reject(err) : resolve();
    });
  });
}

function formatBytes(n) {
  const { floor, pow, max, abs, log } = Math;
  let i = floor(log(max(abs(n), 1)) / log(1000));
  return i === 0 ? formatNumber(n, 0) + ' B' : formatNumber(n / pow(1000, i), 2) + ' ' + ' KMGTPEZY'[i] + 'B';
}

function roundDown(number, precision) {
  let factor = Math.pow(10, precision);
  return Math.floor(number * factor) / factor;
}

function formatNumber(n, decimals = 0, integers = 1) {
  n = roundDown(n, decimals);
  return n.toLocaleString(undefined, {
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals,
    minimumIntegerDigits: integers
  });
}

function padString(str, len) {
  return str + ' '.repeat(Math.max(0, len - str.length));
}

// noinspection JSUnusedGlobalSymbols
function waitIO() {
  return new Promise(resolve => {
    setImmediate(resolve);
  });
}

// noinspection JSUnusedGlobalSymbols
function delay(delayMs) {
  return new Promise(resolve => {
    setTimeout(resolve, delayMs);
  });
}

async function trackProgress(func, loop, delayMs) {
  let running = false;
  let id = setInterval(async () => {
    if (!running) {
      running = true;
      await loop();
      running = false;
    }
  }, delayMs);
  await func();
  clearInterval(id);
  await loop();
}

let nextCid = 1;
function newCid() {
  return nextCid++;
}

/** Shuffle an array in place */
function shuffle(a) {
  let n = a.length;
  // Iterate through all but the last index
  for (let i = 0; i < n - 1; i++) {
    // Pick a random index from i to the end of the array
    let j = i + Math.floor(Math.random() * (n - i));
    // Swap this element with the random one
    let a_i = a[i];
    a[i] = a[j];
    a[j] = a_i;
  }
}

/** Promise.all but without building an array of return values */
async function waitAll(promises) {
  for (let promise of promises) {
    await promise;
  }
}

/**
 * This class is to cap the number of asynchronous jobs entering some code
 * block or using some resource. Construct it with the maximum number of
 * concurrent jobs as a parameter, and use <tt>await counter.inc();</tt> to
 * occupy a slot and <tt>counter.dec();</tt> to return it.
 */
class AsyncCap {
  constructor(max) {
    this.count = 0;
    this.queue = [];

    this.max = max;
  }
  inc() {
    return new Promise((resolve, reject) => {
      this.queue.push({ resolve, reject });
      this.run();
    });
  }
  dec() {
    this.count--;
    this.run();
  }
  run() {
    while (this.queue.length > 0 && this.count < this.max) {
      this.count++;
      this.queue.shift().resolve();
    }
  }
}

exports.AsyncCap = AsyncCap; // noinspection JSUnusedGlobalSymbols

function partition(items, func) {
  let t = [];
  let f = [];
  for (let item of items) {
    (func(item) ? t : f).push(item);
  }
  return [t, f];
}

function sum(items, func) {
  let ret = 0;
  for (let item of items) {
    ret += func(item);
  }
  return ret;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy91dGlsLmpzIl0sIm5hbWVzIjpbInJlcGxhY2VMbiIsInByaW50TG4iLCJmb3JtYXRCeXRlcyIsImZvcm1hdE51bWJlciIsInBhZFN0cmluZyIsIndhaXRJTyIsImRlbGF5IiwidHJhY2tQcm9ncmVzcyIsIm5ld0NpZCIsInNodWZmbGUiLCJ3YWl0QWxsIiwicGFydGl0aW9uIiwic3VtIiwidGV4dCIsIkNMRUFSIiwicHJpbnQiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsInByb2Nlc3MiLCJzdGRvdXQiLCJ3cml0ZSIsImVyciIsIm4iLCJmbG9vciIsInBvdyIsIm1heCIsImFicyIsImxvZyIsIk1hdGgiLCJpIiwicm91bmREb3duIiwibnVtYmVyIiwicHJlY2lzaW9uIiwiZmFjdG9yIiwiZGVjaW1hbHMiLCJpbnRlZ2VycyIsInRvTG9jYWxlU3RyaW5nIiwidW5kZWZpbmVkIiwibWluaW11bUZyYWN0aW9uRGlnaXRzIiwibWF4aW11bUZyYWN0aW9uRGlnaXRzIiwibWluaW11bUludGVnZXJEaWdpdHMiLCJzdHIiLCJsZW4iLCJyZXBlYXQiLCJsZW5ndGgiLCJzZXRJbW1lZGlhdGUiLCJkZWxheU1zIiwic2V0VGltZW91dCIsImZ1bmMiLCJsb29wIiwicnVubmluZyIsImlkIiwic2V0SW50ZXJ2YWwiLCJjbGVhckludGVydmFsIiwibmV4dENpZCIsImEiLCJqIiwicmFuZG9tIiwiYV9pIiwicHJvbWlzZXMiLCJwcm9taXNlIiwiQXN5bmNDYXAiLCJjb25zdHJ1Y3RvciIsImNvdW50IiwicXVldWUiLCJpbmMiLCJwdXNoIiwicnVuIiwiZGVjIiwic2hpZnQiLCJpdGVtcyIsInQiLCJmIiwiaXRlbSIsInJldCJdLCJtYXBwaW5ncyI6Ijs7Ozs7UUFHZ0JBLFMsR0FBQUEsUztRQUtBQyxPLEdBQUFBLE87UUFZQUMsVyxHQUFBQSxXO1FBYUFDLFksR0FBQUEsWTtRQWFBQyxTLEdBQUFBLFM7UUFLQUMsTSxHQUFBQSxNO1FBT0FDLEssR0FB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QVdFLElBQVgsQ0FBZ0IsRUFBQ2xELE9BQUQsRUFBVUMsTUFBVixFQUFoQjtBQUNBLFdBQUtrRCxHQUFMO0FBQ0QsS0FITSxDQUFQO0FBSUQ7QUFDREMsUUFBWTtBQUNWLFNBQUtMLEtBQUw7QUFDQSxTQUFLSSxHQUFMO0FBQ0Q7QUFDREEsUUFBWTtBQUNWLFdBQU8sS0FBS0gsS0FBTCxDQUFXcEIsTUFBWCxHQUFvQixDQUFwQixJQUF5QixLQUFLbUIsS0FBTCxHQUFhLEtBQUt0QyxHQUFsRCxFQUF1RDtBQUNyRCxXQUFLc0MsS0FBTDtBQUNBLFdBQUtDLEtBQUwsQ0FBV0ssS0FBWCxHQUFtQnJELE9BQW5CO0FBQ0Q7QUFDRjtBQXRCbUI7O1FBQVQ2QyxRLEdBQUFBLFEsRUF5QmI7O0FBQ08sU0FBU25ELFNBQVQsQ0FDTDRELEtBREssRUFFTHRCLElBRkssRUFHTztBQUNaLE1BQUl1QixJQUFJLEVBQVI7QUFDQSxNQUFJQyxJQUFJLEVBQVI7QUFDQSxPQUFLLElBQUlDLElBQVQsSUFBaUJILEtBQWpCLEVBQXdCO0FBQ3RCLEtBQUN0QixLQUFLeUIsSUFBTCxJQUFhRixDQUFiLEdBQWlCQyxDQUFsQixFQUFxQk4sSUFBckIsQ0FBMEJPLElBQTFCO0FBQ0Q7QUFDRCxTQUFPLENBQUNGLENBQUQsRUFBSUMsQ0FBSixDQUFQO0FBQ0Q7O0FBRU0sU0FBUzdELEdBQVQsQ0FBZ0IyRCxLQUFoQixFQUFvQ3RCLElBQXBDLEVBQStEO0FBQ3BFLE1BQUkwQixNQUFNLENBQVY7QUFDQSxPQUFLLElBQUlELElBQVQsSUFBaUJILEtBQWpCLEVBQXdCO0FBQ3RCSSxXQUFPMUIsS0FBS3lCLElBQUwsQ0FBUDtBQUNEO0FBQ0QsU0FBT0MsR0FBUDtBQUNEIiwiZmlsZSI6InV0aWwuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuXG4vLyBub2luc3BlY3Rpb24gSlNVbnVzZWRHbG9iYWxTeW1ib2xzXG5leHBvcnQgZnVuY3Rpb24gcmVwbGFjZUxuKHRleHQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICBjb25zdCBDTEVBUiA9ICdcXHJcXHgxQlsyS1xceDFCWz83bCc7XG4gIHJldHVybiBwcmludChDTEVBUiArIHRleHQpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJpbnRMbih0ZXh0OiBzdHJpbmcgPSAnJyk6IFByb21pc2U8dm9pZD4ge1xuICByZXR1cm4gcHJpbnQodGV4dCArICdcXG4nKTtcbn1cblxuZnVuY3Rpb24gcHJpbnQodGV4dDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUodGV4dCwgKGVycjogbWl4ZWQpID0+IHtcbiAgICAgIGVyciA/IHJlamVjdChlcnIpIDogcmVzb2x2ZSgpO1xuICAgIH0pO1xuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZvcm1hdEJ5dGVzKG46IG51bWJlcik6IHN0cmluZyB7XG4gIGNvbnN0IHtmbG9vciwgcG93LCBtYXgsIGFicywgbG9nfSA9IE1hdGg7XG4gIGxldCBpID0gZmxvb3IobG9nKG1heChhYnMobiksIDEpKSAvIGxvZygxMDAwKSk7XG4gIHJldHVybiBpID09PSAwXG4gICAgPyBmb3JtYXROdW1iZXIobiwgMCkgKyAnIEInXG4gICAgOiBmb3JtYXROdW1iZXIobiAvIHBvdygxMDAwLCBpKSwgMikgKyAnICcgKyAnIEtNR1RQRVpZJ1tpXSArICdCJztcbn1cblxuZnVuY3Rpb24gcm91bmREb3duKG51bWJlcjogbnVtYmVyLCBwcmVjaXNpb246IG51bWJlcik6IG51bWJlciB7XG4gIGxldCBmYWN0b3IgPSBNYXRoLnBvdygxMCwgcHJlY2lzaW9uKTtcbiAgcmV0dXJuIE1hdGguZmxvb3IobnVtYmVyICogZmFjdG9yKSAvIGZhY3Rvcjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZvcm1hdE51bWJlcihcbiAgbjogbnVtYmVyLFxuICBkZWNpbWFsczogbnVtYmVyID0gMCxcbiAgaW50ZWdlcnM6IG51bWJlciA9IDEsXG4pOiBzdHJpbmcge1xuICBuID0gcm91bmREb3duKG4sIGRlY2ltYWxzKTtcbiAgcmV0dXJuIG4udG9Mb2NhbGVTdHJpbmcodW5kZWZpbmVkLCB7XG4gICAgbWluaW11bUZyYWN0aW9uRGlnaXRzOiBkZWNpbWFscyxcbiAgICBtYXhpbXVtRnJhY3Rpb25EaWdpdHM6IGRlY2ltYWxzLFxuICAgIG1pbmltdW1JbnRlZ2VyRGlnaXRzOiBpbnRlZ2VycyxcbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwYWRTdHJpbmcoc3RyOiBzdHJpbmcsIGxlbjogbnVtYmVyKTogc3RyaW5nIHtcbiAgcmV0dXJuIHN0ciArICcgJy5yZXBlYXQoTWF0aC5tYXgoMCwgbGVuIC0gc3RyLmxlbmd0aCkpO1xufVxuXG4vLyBub2luc3BlY3Rpb24gSlNVbnVzZWRHbG9iYWxTeW1ib2xzXG5leHBvcnQgZnVuY3Rpb24gd2FpdElPKCk6IFByb21pc2U8dm9pZD4ge1xuICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XG4gICAgc2V0SW1tZWRpYXRlKHJlc29sdmUpO1xuICB9KTtcbn1cblxuLy8gbm9pbnNwZWN0aW9uIEpTVW51c2VkR2xvYmFsU3ltYm9sc1xuZXhwb3J0IGZ1bmN0aW9uIGRlbGF5KGRlbGF5TXM6IG51bWJlcik6IFByb21pc2U8dm9pZD4ge1xuICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XG4gICAgc2V0VGltZW91dChyZXNvbHZlLCBkZWxheU1zKTtcbiAgfSk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB0cmFja1Byb2dyZXNzKFxuICBmdW5jOiAoKSA9PiBQcm9taXNlPHZvaWQ+LFxuICBsb29wOiAoKSA9PiBQcm9taXNlPHZvaWQ+LFxuICBkZWxheU1zOiBudW1iZXIsXG4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgbGV0IHJ1bm5pbmcgPSBmYWxzZTtcbiAgbGV0IGlkID0gc2V0SW50ZXJ2YWwoYXN5bmMgKCkgPT4ge1xuICAgIGlmICghcnVubmluZykge1xuICAgICAgcnVubmluZyA9IHRydWU7XG4gICAgICBhd2FpdCBsb29wKCk7XG4gICAgICBydW5uaW5nID0gZmFsc2U7XG4gICAgfVxuICB9LCBkZWxheU1zKTtcbiAgYXdhaXQgZnVuYygpO1xuICBjbGVhckludGVydmFsKGlkKTtcbiAgYXdhaXQgbG9vcCgpO1xufVxuXG5sZXQgbmV4dENpZCA9IDE7XG5leHBvcnQgZnVuY3Rpb24gbmV3Q2lkKCk6IG51bWJlciB7XG4gIHJldHVybiBuZXh0Q2lkKys7XG59XG5cbi8qKiBTaHVmZmxlIGFuIGFycmF5IGluIHBsYWNlICovXG5leHBvcnQgZnVuY3Rpb24gc2h1ZmZsZTxUPihhOiBUW10pOiB2b2lkIHtcbiAgbGV0IG4gPSBhLmxlbmd0aDtcbiAgLy8gSXRlcmF0ZSB0aHJvdWdoIGFsbCBidXQgdGhlIGxhc3QgaW5kZXhcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBuIC0gMTsgaSsrKSB7XG4gICAgLy8gUGljayBhIHJhbmRvbSBpbmRleCBmcm9tIGkgdG8gdGhlIGVuZCBvZiB0aGUgYXJyYXlcbiAgICBsZXQgaiA9IGkgKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAobiAtIGkpKTtcbiAgICAvLyBTd2FwIHRoaXMgZWxlbWVudCB3aXRoIHRoZSByYW5kb20gb25lXG4gICAgbGV0IGFfaSA9IGFbaV07XG4gICAgYVtpXSA9IGFbal07XG4gICAgYVtqXSA9IGFfaTtcbiAgfVxufVxuXG4vKiogUHJvbWlzZS5hbGwgYnV0IHdpdGhvdXQgYnVpbGRpbmcgYW4gYXJyYXkgb2YgcmV0dXJuIHZhbHVlcyAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHdhaXRBbGwoXG4gIHByb21pc2VzOiBJdGVyYWJsZTxQcm9taXNlPHZvaWQ+Pixcbik6IFByb21pc2U8dm9pZD4ge1xuICBmb3IgKGxldCBwcm9taXNlIG9mIHByb21pc2VzKSB7XG4gICAgYXdhaXQgcHJvbWlzZTtcbiAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFBlbmRpbmdQcm9taXNlPFQ+IHtcbiAgK3Jlc29sdmU6IFQgPT4gdm9pZDtcbiAgK3JlamVjdDogbWl4ZWQgPT4gdm9pZDtcbn1cblxuLyoqXG4gKiBUaGlzIGNsYXNzIGlzIHRvIGNhcCB0aGUgbnVtYmVyIG9mIGFzeW5jaHJvbm91cyBqb2JzIGVudGVyaW5nIHNvbWUgY29kZVxuICogYmxvY2sgb3IgdXNpbmcgc29tZSByZXNvdXJjZS4gQ29uc3RydWN0IGl0IHdpdGggdGhlIG1heGltdW0gbnVtYmVyIG9mXG4gKiBjb25jdXJyZW50IGpvYnMgYXMgYSBwYXJhbWV0ZXIsIGFuZCB1c2UgPHR0PmF3YWl0IGNvdW50ZXIuaW5jKCk7PC90dD4gdG9cbiAqIG9jY3VweSBhIHNsb3QgYW5kIDx0dD5jb3VudGVyLmRlYygpOzwvdHQ+IHRvIHJldHVybiBpdC5cbiAqL1xuZXhwb3J0IGNsYXNzIEFzeW5jQ2FwIHtcbiAgY291bnQ6IG51bWJlciA9IDA7XG4gIHF1ZXVlOiBQZW5kaW5nUHJvbWlzZTx2b2lkPltdID0gW107XG4gIG1heDogbnVtYmVyO1xuICBjb25zdHJ1Y3RvcihtYXg6IG51bWJlcikge1xuICAgIHRoaXMubWF4ID0gbWF4O1xuICB9XG4gIGluYygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5xdWV1ZS5wdXNoKHtyZXNvbHZlLCByZWplY3R9KTtcbiAgICAgIHRoaXMucnVuKCk7XG4gICAgfSk7XG4gIH1cbiAgZGVjKCk6IHZvaWQge1xuICAgIHRoaXMuY291bnQtLTtcbiAgICB0aGlzLnJ1bigpO1xuICB9XG4gIHJ1bigpOiB2b2lkIHtcbiAgICB3aGlsZSAodGhpcy5xdWV1ZS5sZW5ndGggPiAwICYmIHRoaXMuY291bnQgPCB0aGlzLm1heCkge1xuICAgICAgdGhpcy5jb3VudCsrO1xuICAgICAgdGhpcy5xdWV1ZS5zaGlmdCgpLnJlc29sdmUoKTtcbiAgICB9XG4gIH1cbn1cblxuLy8gbm9pbnNwZWN0aW9uIEpTVW51c2VkR2xvYmFsU3ltYm9sc1xuZXhwb3J0IGZ1bmN0aW9uIHBhcnRpdGlvbjxUPihcbiAgaXRlbXM6IEl0ZXJhYmxlPFQ+LFxuICBmdW5jOiBUID0+IGJvb2xlYW4sXG4pOiBbVFtdLCBUW11dIHtcbiAgbGV0IHQgPSBbXTtcbiAgbGV0IGYgPSBbXTtcbiAgZm9yIChsZXQgaXRlbSBvZiBpdGVtcykge1xuICAgIChmdW5jKGl0ZW0pID8gdCA6IGYpLnB1c2goaXRlbSk7XG4gIH1cbiAgcmV0dXJuIFt0LCBmXTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHN1bTxUPihpdGVtczogSXRlcmFibGU8VD4sIGZ1bmM6IFQgPT4gbnVtYmVyKTogbnVtYmVyIHtcbiAgbGV0IHJldCA9IDA7XG4gIGZvciAobGV0IGl0ZW0gb2YgaXRlbXMpIHtcbiAgICByZXQgKz0gZnVuYyhpdGVtKTtcbiAgfVxuICByZXR1cm4gcmV0O1xufVxuIl19